#!/bin/bash

###############################################################################
# üöÄ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ SunnySiouxCare —Å GitHub
# –í–µ—Ä—Å–∏—è: 2.0
# –î–∞—Ç–∞: 21 –æ–∫—Ç—è–±—Ä—è 2025
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: curl -fsSL https://raw.githubusercontent.com/mrolivershea-cyber/sunny-sioux-care/main/install-from-github.sh | sudo bash
###############################################################################

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
PROJECT_DIR="/var/www/sunny-sioux-care"
GITHUB_REPO="https://github.com/mrolivershea-cyber/sunny-sioux-care.git"
GITHUB_BRANCH="main"

###############################################################################
# –§—É–Ω–∫—Ü–∏–∏
###############################################################################

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

###############################################################################
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
###############################################################################

check_system() {
    log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –û–°
    if [ ! -f /etc/os-release ]; then
        log_error "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –û–°"
        exit 1
    fi
    
    . /etc/os-release
    if [[ "$ID" != "ubuntu" && "$ID" != "debian" ]]; then
        log_warning "–û–° –Ω–µ Ubuntu/Debian, –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º—ã"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ root
    if [ "$EUID" -ne 0 ]; then 
        log_error "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å sudo"
        exit 1
    fi
    
    log_success "–°–∏—Å—Ç–µ–º–∞: $PRETTY_NAME"
}

###############################################################################
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
###############################################################################

check_existing() {
    if [ -d "$PROJECT_DIR" ]; then
        log_warning "–ü—Ä–æ–µ–∫—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ $PROJECT_DIR"
        echo
        echo "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
        echo "  1) –£–¥–∞–ª–∏—Ç—å –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (–≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã!)"
        echo "  2) –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–µ–∫—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
        echo "  3) –û—Ç–º–µ–Ω–∞"
        echo
        read -p "–í–∞—à –≤—ã–±–æ—Ä (1/2/3): " -n 1 -r
        echo
        
        case $REPLY in
            1)
                log_warning "–£–¥–∞–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞..."
                # –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                BACKUP_FILE="/var/www/sunny-sioux-care-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
                tar -czf "$BACKUP_FILE" "$PROJECT_DIR" 2>/dev/null || true
                log_info "–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_FILE"
                
                rm -rf "$PROJECT_DIR"
                log_success "–°—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç —É–¥–∞–ª–µ–Ω"
                ;;
            2)
                log_info "–ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."
                if [ -f "$PROJECT_DIR/update-from-github.sh" ]; then
                    bash "$PROJECT_DIR/update-from-github.sh"
                else
                    log_error "–°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω"
                    log_info "–°–∫–∞—á–∞–π—Ç–µ update-from-github.sh –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
                fi
                exit 0
                ;;
            3)
                log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
                exit 0
                ;;
            *)
                log_error "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
                exit 1
                ;;
        esac
    fi
}

###############################################################################
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
###############################################################################

install_system_dependencies() {
    log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    # –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤
    apt-get update -qq
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        curl \
        git \
        python3.11 \
        python3.11-venv \
        python3-pip \
        nginx \
        supervisor \
        certbot \
        python3-certbot-nginx \
        ufw \
        gnupg \
        build-essential
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å MongoDB
    log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ MongoDB 7.0..."
    curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-7.0.list
    apt-get update -qq
    apt-get install -y mongodb-org
    systemctl enable mongod
    systemctl start mongod
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Node.js 20
    if ! command -v node &> /dev/null || [ "$(node -v | cut -d'.' -f1 | sed 's/v//')" -lt 20 ]; then
        log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 20..."
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
        apt-get install -y nodejs
    fi
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Yarn
    if ! command -v yarn &> /dev/null; then
        npm install -g yarn
    fi
    
    log_success "–°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

###############################################################################
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—á—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
###############################################################################

install_email_server() {
    log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—á—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (Postfix + Dovecot + OpenDKIM)..."
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        postfix \
        dovecot-core \
        dovecot-imapd \
        dovecot-pop3d \
        opendkim \
        opendkim-tools \
        mailutils
    
    # –°–æ–∑–¥–∞—Ç—å email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    EMAIL_USER="info"
    EMAIL_PASSWORD=$(openssl rand -base64 24)
    useradd -m -s /bin/bash "$EMAIL_USER" 2>/dev/null || true
    echo "$EMAIL_USER:$EMAIL_PASSWORD" | chpasswd
    mkdir -p /home/$EMAIL_USER/Maildir/{cur,new,tmp}
    chown -R $EMAIL_USER:$EMAIL_USER /home/$EMAIL_USER/Maildir
    chmod -R 700 /home/$EMAIL_USER/Maildir
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
    echo "$EMAIL_PASSWORD" > /root/email_password.txt

###############################################################################
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—á—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
###############################################################################

configure_email_server() {
    if [ ! -f /root/email_password.txt ]; then
        log_info "–ü–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É"
        return
    fi
    
    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—á—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞..."
    
    EMAIL_PASSWORD=$(cat /root/email_password.txt)
    DOMAIN="sunnysiouxcare.com"
    
    # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Postfix
    cat > /etc/postfix/main.cf << 'EOFPOSTFIX'
myhostname = mail.sunnysiouxcare.com
mydomain = sunnysiouxcare.com
myorigin = $mydomain
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
relayhost =
mynetworks = 127.0.0.0/8
inet_interfaces = all
inet_protocols = all
home_mailbox = Maildir/

smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_tls_security_level=may

smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes

smtpd_relay_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
EOFPOSTFIX

    # –î–æ–±–∞–≤–∏—Ç—å submission –ø–æ—Ä—Ç
    grep -q "^submission inet" /etc/postfix/master.cf || cat >> /etc/postfix/master.cf << 'EOFSUB'

submission inet n - y - - smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=may
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_sasl_type=dovecot
  -o smtpd_sasl_path=private/auth
EOFSUB

    # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Dovecot
    sed -i 's|mail_location = .*|mail_location = maildir:~/Maildir|' /etc/dovecot/conf.d/10-mail.conf 2>/dev/null || true
    sed -i 's|#disable_plaintext_auth = yes|disable_plaintext_auth = yes|' /etc/dovecot/conf.d/10-auth.conf 2>/dev/null || true
    sed -i 's|auth_mechanisms = plain|auth_mechanisms = plain login|' /etc/dovecot/conf.d/10-auth.conf 2>/dev/null || true
    
    # –ü—Ä–æ—Å—Ç–æ–π 10-master.conf
    cat > /etc/dovecot/conf.d/10-master.conf << 'EOFMASTER'
service imap-login {
  inet_listener imaps {
    port = 993
    ssl = yes
  }
}

service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    user = postfix
    group = postfix
  }
}
EOFMASTER

    # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
    systemctl restart postfix dovecot 2>/dev/null || true
    
    log_success "–ü–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
}

    chmod 600 /root/email_password.txt
    
    log_success "–ü–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    log_info "Email: info@sunnysiouxcare.com | –ü–∞—Ä–æ–ª—å –≤ /root/email_password.txt"
}

###############################################################################
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
###############################################################################

clone_repository() {
    log_info "–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å GitHub..."
    
    mkdir -p /var/www
    cd /var/www
    
    git clone "$GITHUB_REPO" sunny-sioux-care
    cd sunny-sioux-care
    git checkout "$GITHUB_BRANCH"
    
    log_success "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω"
}

###############################################################################
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Backend
###############################################################################

setup_backend() {
    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Backend..."
    
    cd "$PROJECT_DIR/backend"
    
    # –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    python3.11 -m venv venv
    source venv/bin/activate
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    pip install --upgrade pip
    pip install -r requirements.txt
    
    # –°–æ–∑–¥–∞—Ç—å .env –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if [ ! -f .env ]; then
        cp .env.example .env
        log_warning "–°–æ–∑–¥–∞–Ω backend/.env - –ó–ê–ü–û–õ–ù–ò–¢–ï –°–í–û–ò–ú–ò –î–ê–ù–ù–´–ú–ò!"
        
        echo
        log_info "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:"
        echo "  ‚Ä¢ PAYPAL_CLIENT_ID"
        echo "  ‚Ä¢ PAYPAL_CLIENT_SECRET"
        echo "  ‚Ä¢ EMAIL_ENABLED –∏ SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ—á—Ç–∞)"
        echo
        read -p "–ù–∞–∂–º–∏—Ç–µ Enter –∫–æ–≥–¥–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ .env..."
    fi
    
    deactivate
    
    log_success "Backend –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
}

###############################################################################
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Frontend
###############################################################################

setup_frontend() {
    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Frontend..."
    
    cd "$PROJECT_DIR/frontend"
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    yarn install
    
    # –°–æ–∑–¥–∞—Ç—å .env –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if [ ! -f .env ]; then
        cp .env.example .env
        log_warning "–°–æ–∑–¥–∞–Ω frontend/.env"
        
        # –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ–º–µ–Ω
        echo
        read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://sunnysiouxcare.com): " DOMAIN
        sed -i "s|https://sunny-installer.preview.emergentagent.com|$DOMAIN|g" .env
    fi
    
    # –°–æ–±—Ä–∞—Ç—å frontend
    log_info "–°–±–æ—Ä–∫–∞ frontend (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)..."
    export NODE_OPTIONS="--max-old-space-size=1024"
    yarn build
    
    log_success "Frontend –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Å–æ–±—Ä–∞–Ω"
}

###############################################################################
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Supervisor
###############################################################################

setup_supervisor() {
    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Supervisor..."
    
    # Backend
    cat > /etc/supervisor/conf.d/sunny-backend.conf << EOF
[program:backend]
directory=$PROJECT_DIR/backend
command=$PROJECT_DIR/backend/venv/bin/python -m uvicorn server:app --host 0.0.0.0 --port 8001
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/backend.err.log
stdout_logfile=/var/log/supervisor/backend.out.log
environment=PYTHONPATH="$PROJECT_DIR/backend"
EOF
    
    # Frontend (—Å—Ç–∞—Ç–∏—á–Ω—ã–π, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    
    supervisorctl reread
    supervisorctl update
    supervisorctl start backend
    
    log_success "Supervisor –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
}

###############################################################################
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx
###############################################################################

setup_nginx() {
    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx..."
    
    echo
    read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: sunnysiouxcare.com): " DOMAIN
    
    cat > /etc/nginx/sites-available/sunnysiouxcare << EOF
server {
    listen 80;
    server_name $DOMAIN www.$DOMAIN;
    
    # Frontend
    root $PROJECT_DIR/frontend/build;
    index index.html;
    
    location / {
        try_files \$uri \$uri/ /index.html;
    }
    
    # Backend API
    location /api {
        proxy_pass http://localhost:8001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_cache_bypass \$http_upgrade;
    }
    
    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
}
EOF
    
    # –í–∫–ª—é—á–∏—Ç—å —Å–∞–π—Ç
    ln -sf /etc/nginx/sites-available/sunnysiouxcare /etc/nginx/sites-enabled/
    rm -f /etc/nginx/sites-enabled/default
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    nginx -t
    systemctl restart nginx
    
    log_success "Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    
    # SSL
    log_info "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Let's Encrypt?"
    read -p "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSL? (y/n): " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
        certbot --nginx -d "$DOMAIN" -d "www.$DOMAIN" --non-interactive --agree-tos --register-unsafely-without-email || log_warning "SSL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é"
    fi
}

###############################################################################
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall
###############################################################################

setup_firewall() {
    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall..."
    
    # –†–∞–∑—Ä–µ—à–∏—Ç—å –Ω—É–∂–Ω—ã–µ –ø–æ—Ä—Ç—ã
    ufw allow ssh
    ufw allow http
    ufw allow https
    ufw allow 587/tcp  # SMTP
    ufw allow 993/tcp  # IMAP
    ufw allow 25/tcp   # SMTP (–ø–æ–ª—É—á–µ–Ω–∏–µ)
    
    # –í–∫–ª—é—á–∏—Ç—å firewall
    echo "y" | ufw enable || true
    
    log_success "Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
}

###############################################################################
# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
###############################################################################

final_check() {
    log_info "–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
    
    sleep 3
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
    supervisorctl status
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å backend
    if curl -f -s http://localhost:8001/api/status > /dev/null 2>&1; then
        log_success "‚úì Backend —Ä–∞–±–æ—Ç–∞–µ—Ç"
    else
        log_warning "‚ö† Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Nginx
    if systemctl is-active --quiet nginx; then
        log_success "‚úì Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç"
    else
        log_warning "‚ö† Nginx –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi
}

###############################################################################
# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
###############################################################################

main() {
    clear
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "  üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SunnySiouxCare.com —Å GitHub"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo
    
    check_system
    check_existing
    install_system_dependencies
    install_email_server
    configure_email_server
    clone_repository
    setup_backend
    setup_frontend
    setup_supervisor
    setup_nginx
    setup_firewall
    final_check
    
    echo
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    log_success "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo
    log_info "üìã –ß—Ç–æ –¥–∞–ª—å—à–µ:"
    echo "  1. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ backend/.env (PayPal –∫–ª—é—á–∏, email –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)"
    echo "  2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend: sudo supervisorctl restart backend"
    echo "  3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ DNS –¥–ª—è –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞"
    echo "  4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä (—Å–º. EMAIL_SERVER_SUCCESS.md)"
    echo
    log_info "üìÇ –ü—Ä–æ–µ–∫—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤: $PROJECT_DIR"
    log_info "üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:"
    echo "  ‚Ä¢ README.md - –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è"
    echo "  ‚Ä¢ EMAIL_SERVER_SUCCESS.md - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—á—Ç—ã"
    echo "  ‚Ä¢ DNS_EMAIL_SETUP.md - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS"
    echo
    log_info "üîÑ –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –±—É–¥—É—â–µ–º:"
    echo "  cd $PROJECT_DIR && sudo bash update-from-github.sh"
    echo
    log_success "–ì–æ—Ç–æ–≤–æ! üéâ"
    echo
}

###############################################################################
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
###############################################################################

trap 'log_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ."' ERR

###############################################################################
# –ó–∞–ø—É—Å–∫
###############################################################################

main "$@"
