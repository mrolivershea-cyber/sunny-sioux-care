#!/bin/bash

################################################################################
# –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –£–°–¢–ê–ù–û–í–©–ò–ö SUNNYSIOUXCARE.COM
# –í–µ—Ä—Å–∏—è: FINAL 1.0
# –û–¥–∏–Ω —Å–∫—Ä–∏–ø—Ç - –ø–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ + —Ç–µ—Å—Ç—ã
# –î–ª—è Ubuntu 22.04 LTS
################################################################################

set -e

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
exec > >(tee /root/install-$(date +%Y%m%d-%H%M%S).log)
exec 2>&1

clear
cat << "EOF"
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         üöÄ SUNNYSIOUXCARE.COM - –ê–í–¢–û–£–°–¢–ê–ù–û–í–ö–ê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
EOF
echo ""
sleep 1

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è –¥–ª—è email
EMAIL_PASSWORD=$(openssl rand -base64 24)
SERVER_IP=$(hostname -I | awk '{print $1}')

################################################################################
echo "‚ñ∫ [1/11] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
################################################################################
apt-get update -qq 2>&1 | grep -v "^Get:" | grep -v "^Hit:" || true
DEBIAN_FRONTEND=noninteractive apt-get upgrade -y -qq 2>&1 >/dev/null
echo "   ‚úì –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞"

################################################################################
echo "‚ñ∫ [2/11] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
################################################################################
DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
    curl wget git nano htop \
    build-essential \
    python3.11 python3.11-venv python3-pip \
    nginx \
    certbot python3-certbot-nginx \
    ufw \
    gnupg \
    ca-certificates \
    apt-transport-https \
    2>&1 >/dev/null
echo "   ‚úì –ë–∞–∑–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

################################################################################
echo "‚ñ∫ [3/11] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ MongoDB 7.0..."
################################################################################
curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc 2>/dev/null | \
    gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg 2>/dev/null

echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" \
    > /etc/apt/sources.list.d/mongodb-org-7.0.list

apt-get update -qq 2>&1 | grep -v "^Get:" | grep -v "^Hit:" || true
DEBIAN_FRONTEND=noninteractive apt-get install -y -qq mongodb-org 2>&1 >/dev/null

systemctl enable mongod >/dev/null 2>&1
systemctl start mongod
sleep 3

if systemctl is-active --quiet mongod; then
    echo "   ‚úì MongoDB 7.0 –∑–∞–ø—É—â–µ–Ω"
else
    echo "   ‚úó MongoDB –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi

################################################################################
echo "‚ñ∫ [4/11] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 20..."
################################################################################
curl -fsSL https://deb.nodesource.com/setup_20.x 2>/dev/null | bash - >/dev/null 2>&1
DEBIAN_FRONTEND=noninteractive apt-get install -y -qq nodejs 2>&1 >/dev/null
npm install -g yarn pm2 >/dev/null 2>&1
echo "   ‚úì Node.js $(node -v) + Yarn + PM2"

################################################################################
echo "‚ñ∫ [5/11] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—á—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞..."
################################################################################
DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
    postfix \
    dovecot-core \
    dovecot-imapd \
    dovecot-pop3d \
    opendkim \
    opendkim-tools \
    mailutils \
    2>&1 >/dev/null
echo "   ‚úì Postfix + Dovecot + OpenDKIM —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

################################################################################
echo "‚ñ∫ [6/11] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—á—Ç—ã (info@sunnysiouxcare.com)..."
################################################################################

# –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
useradd -m -s /bin/bash info 2>/dev/null || true
echo "info:$EMAIL_PASSWORD" | chpasswd
mkdir -p /home/info/Maildir/{cur,new,tmp}
chown -R info:info /home/info/Maildir
chmod -R 700 /home/info/Maildir
echo "$EMAIL_PASSWORD" > /root/email_password.txt
chmod 600 /root/email_password.txt

# Postfix –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
cat > /etc/postfix/main.cf << 'EOFPOSTFIX'
myhostname = mail.sunnysiouxcare.com
mydomain = sunnysiouxcare.com
myorigin = $mydomain
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
relayhost =
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
inet_interfaces = all
inet_protocols = ipv4
home_mailbox = Maildir/
mailbox_size_limit = 0
recipient_delimiter = +

smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_tls_security_level=may

smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous

smtpd_relay_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
EOFPOSTFIX

# Submission –ø–æ—Ä—Ç –≤ master.cf
if ! grep -q "^submission inet" /etc/postfix/master.cf 2>/dev/null; then
cat >> /etc/postfix/master.cf << 'EOFSUBMISSION'

submission inet n       -       y       -       -       smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=may
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_sasl_type=dovecot
  -o smtpd_sasl_path=private/auth
  -o smtpd_client_restrictions=permit_sasl_authenticated,reject
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
EOFSUBMISSION
fi

# Dovecot –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
sed -i 's|mail_location = .*|mail_location = maildir:~/Maildir|' /etc/dovecot/conf.d/10-mail.conf 2>/dev/null || true
sed -i 's|#disable_plaintext_auth = yes|disable_plaintext_auth = yes|' /etc/dovecot/conf.d/10-auth.conf 2>/dev/null || true
sed -i 's|auth_mechanisms = plain|auth_mechanisms = plain login|' /etc/dovecot/conf.d/10-auth.conf 2>/dev/null || true

# –°–æ–∑–¥–∞—Ç—å —á–∏—Å—Ç—ã–π 10-master.conf
cat > /etc/dovecot/conf.d/10-master.conf << 'EOFDOVECOT'
service imap-login {
  inet_listener imap {
    port = 143
  }
  inet_listener imaps {
    port = 993
    ssl = yes
  }
}

service pop3-login {
  inet_listener pop3 {
    port = 110
  }
  inet_listener pop3s {
    port = 995
    ssl = yes
  }
}

service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    user = postfix
    group = postfix
  }
}
EOFDOVECOT

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—á—Ç–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã
systemctl restart postfix
systemctl restart dovecot

if systemctl is-active --quiet postfix && systemctl is-active --quiet dovecot; then
    echo "   ‚úì –ü–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω"
    if ss -tlnp 2>/dev/null | grep -q ":587"; then
        echo "   ‚úì SMTP –ø–æ—Ä—Ç 587 –æ—Ç–∫—Ä—ã—Ç"
    fi
else
    echo "   ‚úó –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ—á—Ç–æ–≤—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º"
fi

################################################################################
echo "‚ñ∫ [7/11] –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ GitHub..."
################################################################################
cd /var/www
rm -rf sunny-sioux-care 2>/dev/null || true
git clone https://github.com/mrolivershea-cyber/sunny-sioux-care.git 2>&1 | \
    grep -E "Cloning|done" || true
echo "   ‚úì –ü—Ä–æ–µ–∫—Ç —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω"

################################################################################
echo "‚ñ∫ [8/11] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Backend..."
################################################################################
cd /var/www/sunny-sioux-care/backend

# –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
python3.11 -m venv venv
source venv/bin/activate
pip install --quiet --upgrade pip
pip install --quiet -r requirements.txt
deactivate

# –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª
cat > .env << EOFENV
MONGO_URL="mongodb://localhost:27017"
DB_NAME="sunnysiouxcare_production"
CORS_ORIGINS="*"

PAYPAL_CLIENT_ID="AZt9GrVjcdkpNicpgd45onNoltmXr81q9YnYQu55cL-zevpfsPP-n3TkN7oBwO3L9hMPfEOenMMDduqg"
PAYPAL_CLIENT_SECRET="ENGgk6krA1WJFu3KRRiIMCa67W7pk9lkuZvW2kM6EBwb5-2x9-_kUYyi_Nm9SSTjAHlzn3GRP9_zfP9x"
PAYPAL_MODE="live"

EMAIL_ENABLED="true"
SMTP_HOST="localhost"
SMTP_PORT="587"
SMTP_USER="info"
SMTP_PASSWORD="$EMAIL_PASSWORD"
FROM_EMAIL="info@sunnysiouxcare.com"
ADMIN_EMAIL="info@sunnysiouxcare.com"
EOFENV

# PM2 ecosystem config
cat > ecosystem.config.js << 'EOFECOSYSTEM'
module.exports = {
  apps: [{
    name: 'sunnysiouxcare-backend',
    script: 'venv/bin/python',
    args: '-m uvicorn server:app --host 0.0.0.0 --port 8001',
    cwd: '/var/www/sunny-sioux-care/backend',
    interpreter: 'none',
    env: {
      PYTHONPATH: '/var/www/sunny-sioux-care/backend'
    },
    autorestart: true,
    max_memory_restart: '500M'
  }]
};
EOFECOSYSTEM

echo "   ‚úì Backend –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

################################################################################
echo "‚ñ∫ [9/11] –°–±–æ—Ä–∫–∞ Frontend..."
################################################################################
cd /var/www/sunny-sioux-care/frontend

# .env –¥–ª—è frontend
cat > .env << 'EOFENV'
REACT_APP_BACKEND_URL=https://sunnysiouxcare.com
WDS_SOCKET_PORT=443
EOFENV

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
yarn install 2>&1 | grep -E "success|Done" || true

# –°–±–æ—Ä–∫–∞
export NODE_OPTIONS="--max-old-space-size=1536"
echo "   ‚è≥ –°–±–æ—Ä–∫–∞ (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 1-2 –º–∏–Ω—É—Ç—ã)..."
yarn build 2>&1 | grep -E "Compiled|File sizes|Done in" || true

if [ -f "build/index.html" ]; then
    echo "   ‚úì Frontend —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "   ‚úó Frontend –Ω–µ —Å–æ–±—Ä–∞–ª—Å—è!"
    exit 1
fi

################################################################################
echo "‚ñ∫ [10/11] –ó–∞–ø—É—Å–∫ Backend —á–µ—Ä–µ–∑ PM2..."
################################################################################
cd /var/www/sunny-sioux-care/backend

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã
pm2 delete all 2>/dev/null || true
pm2 kill 2>/dev/null || true

# –ó–∞–ø—É—Å—Ç–∏—Ç—å backend
pm2 start ecosystem.config.js
sleep 3

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
pm2 save >/dev/null 2>&1
pm2 startup 2>/dev/null | tail -1 | bash >/dev/null 2>&1 || true

# –ü—Ä–æ–≤–µ—Ä–∫–∞
if pm2 list | grep -q "online"; then
    echo "   ‚úì Backend –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ PM2"
else
    echo "   ‚úó Backend –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
    pm2 logs --lines 10
    exit 1
fi

################################################################################
echo "‚ñ∫ [11/11] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx..."
################################################################################

# –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
cat > /etc/nginx/sites-available/sunnysiouxcare << 'EOFNGINX'
server {
    listen 80;
    server_name sunnysiouxcare.com www.sunnysiouxcare.com;
    
    root /var/www/sunny-sioux-care/frontend/build;
    index index.html;
    
    location /api/ {
        proxy_pass http://127.0.0.1:8001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
    
    location / {
        try_files $uri /index.html;
    }
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
EOFNGINX

# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–∞–π—Ç
rm -f /etc/nginx/sites-enabled/default
rm -f /etc/nginx/sites-enabled/*
ln -sf /etc/nginx/sites-available/sunnysiouxcare /etc/nginx/sites-enabled/sunnysiouxcare

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
if nginx -t 2>&1 | grep -q "successful"; then
    systemctl reload nginx
    echo "   ‚úì Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
else
    echo "   ‚úó –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx!"
    nginx -t
    exit 1
fi

################################################################################
echo "‚ñ∫ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firewall..."
################################################################################
ufw allow 22/tcp comment 'SSH' >/dev/null 2>&1
ufw allow 80/tcp comment 'HTTP' >/dev/null 2>&1
ufw allow 443/tcp comment 'HTTPS' >/dev/null 2>&1
ufw allow 25/tcp comment 'SMTP' >/dev/null 2>&1
ufw allow 587/tcp comment 'SMTP Submission' >/dev/null 2>&1
ufw allow 993/tcp comment 'IMAP SSL' >/dev/null 2>&1
ufw allow 995/tcp comment 'POP3 SSL' >/dev/null 2>&1
echo "y" | ufw enable >/dev/null 2>&1
echo "   ‚úì Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

################################################################################
echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "                 üß™ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
################################################################################

sleep 2

# –¢–µ—Å—Ç 1: MongoDB
echo -n "‚ñ∫ MongoDB.......... "
if systemctl is-active --quiet mongod; then
    echo "‚úÖ –†–ê–ë–û–¢–ê–ï–¢"
else
    echo "‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
fi

# –¢–µ—Å—Ç 2: Backend PM2
echo -n "‚ñ∫ Backend PM2...... "
if pm2 list 2>/dev/null | grep -q "online"; then
    echo "‚úÖ –†–ê–ë–û–¢–ê–ï–¢"
else
    echo "‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
fi

# –¢–µ—Å—Ç 3: Backend API
echo -n "‚ñ∫ Backend API...... "
sleep 2
if curl -s http://localhost:8001/api/status >/dev/null 2>&1; then
    echo "‚úÖ –û–¢–í–ï–ß–ê–ï–¢"
else
    echo "‚ö†Ô∏è  –ù–ï –û–¢–í–ï–ß–ê–ï–¢ (–º–æ–∂–µ—Ç –Ω—É–∂–Ω–æ –≤—Ä–µ–º—è)"
fi

# –¢–µ—Å—Ç 4: Frontend Build
echo -n "‚ñ∫ Frontend Build... "
if [ -f "/var/www/sunny-sioux-care/frontend/build/index.html" ]; then
    echo "‚úÖ –°–û–ë–†–ê–ù"
else
    echo "‚ùå –ù–ï –°–û–ë–†–ê–ù"
fi

# –¢–µ—Å—Ç 5: Nginx
echo -n "‚ñ∫ Nginx............ "
if systemctl is-active --quiet nginx; then
    echo "‚úÖ –†–ê–ë–û–¢–ê–ï–¢"
else
    echo "‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
fi

# –¢–µ—Å—Ç 6: –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω
echo -n "‚ñ∫ –°–∞–π—Ç (HTTP)...... "
if curl -s -I http://localhost 2>&1 | grep -q "200 OK"; then
    echo "‚úÖ –î–û–°–¢–£–ü–ï–ù"
else
    echo "‚ùå –ù–ï –î–û–°–¢–£–ü–ï–ù"
fi

# –¢–µ—Å—Ç 7: Postfix
echo -n "‚ñ∫ Postfix.......... "
if systemctl is-active --quiet postfix; then
    echo "‚úÖ –†–ê–ë–û–¢–ê–ï–¢"
else
    echo "‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
fi

# –¢–µ—Å—Ç 8: Postfix –ø–æ—Ä—Ç 587
echo -n "‚ñ∫ SMTP –ø–æ—Ä—Ç 587.... "
if ss -tlnp 2>/dev/null | grep -q ":587"; then
    echo "‚úÖ –û–¢–ö–†–´–¢"
else
    echo "‚ö†Ô∏è  –ù–ï –°–õ–£–®–ê–ï–¢"
fi

# –¢–µ—Å—Ç 9: Dovecot
echo -n "‚ñ∫ Dovecot.......... "
if systemctl is-active --quiet dovecot; then
    echo "‚úÖ –†–ê–ë–û–¢–ê–ï–¢"
else
    echo "‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
fi

# –¢–µ—Å—Ç 10: PayPal –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
echo -n "‚ñ∫ PayPal API....... "
if grep -q "PAYPAL_CLIENT_ID" /var/www/sunny-sioux-care/backend/.env 2>/dev/null; then
    echo "‚úÖ –ù–ê–°–¢–†–û–ï–ù"
else
    echo "‚ö†Ô∏è  –ù–ï –ù–ê–°–¢–†–û–ï–ù"
fi

################################################################################
echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "              ‚úÖ –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""
echo "üåê –í–ê–® –°–ê–ô–¢:"
echo "   –ü–æ IP:     http://$SERVER_IP"
echo "   –ü–æ –¥–æ–º–µ–Ω—É: https://sunnysiouxcare.com (–ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DNS)"
echo ""
echo "üìß –ü–û–ß–¢–ê:"
echo "   Email:  info@sunnysiouxcare.com"
echo "   –ü–∞—Ä–æ–ª—å: $EMAIL_PASSWORD"
echo "   –§–∞–π–ª:   /root/email_password.txt"
echo ""
echo "   SMTP:   mail.sunnysiouxcare.com:587 (STARTTLS)"
echo "   IMAP:   mail.sunnysiouxcare.com:993 (SSL)"
echo ""
echo "üîß –£–ü–†–ê–í–õ–ï–ù–ò–ï:"
echo "   Backend:  pm2 status | pm2 logs | pm2 restart sunnysiouxcare-backend"
echo "   Nginx:    systemctl status nginx | systemctl reload nginx"
echo "   –ü–æ—á—Ç–∞:    systemctl status postfix dovecot"
echo "   MongoDB:  systemctl status mongod"
echo ""
echo "üìã DNS –ó–ê–ü–ò–°–ò (–æ–±–Ω–æ–≤–∏—Ç–µ –≤ Namecheap):"
echo "   A Record:    @     ‚Üí  $SERVER_IP"
echo "   A Record:    www   ‚Üí  $SERVER_IP"
echo "   A Record:    mail  ‚Üí  $SERVER_IP"
echo "   MX Record:   @     ‚Üí  mail.sunnysiouxcare.com (Priority: 10)"
echo "   TXT (SPF):   @     ‚Üí  v=spf1 ip4:$SERVER_IP a mx ~all"
echo ""
echo "üìå –ü–û–°–õ–ï –û–ë–ù–û–í–õ–ï–ù–ò–Ø DNS (15-30 –º–∏–Ω—É—Ç):"
echo "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ SSL:"
echo "   certbot --nginx -d sunnysiouxcare.com -d www.sunnysiouxcare.com --email info@sunnysiouxcare.com --agree-tos --non-interactive"
echo ""
echo "üß™ –ë–´–°–¢–†–ê–Ø –ü–†–û–í–ï–†–ö–ê:"
echo "   curl http://localhost:8001/api/status"
echo "   curl -I http://$SERVER_IP"
echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""
echo "üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°:"
pm2 status
echo ""
